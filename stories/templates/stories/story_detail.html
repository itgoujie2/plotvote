{% extends 'base.html' %}

{% block title %}{{ seo_meta.title }}{% endblock %}
{% block meta_title %}{{ seo_meta.title }}{% endblock %}
{% block meta_description %}{{ seo_meta.description }}{% endblock %}
{% block meta_keywords %}{{ seo_meta.keywords }}{% endblock %}

{% block canonical_url %}{{ seo_meta.url }}{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ seo_meta.title }}{% endblock %}
{% block og_description %}{{ seo_meta.description }}{% endblock %}
{% block og_image %}{{ seo_meta.image }}{% endblock %}

{% block twitter_title %}{{ seo_meta.title }}{% endblock %}
{% block twitter_description %}{{ seo_meta.description }}{% endblock %}
{% block twitter_image %}{{ seo_meta.image }}{% endblock %}

{% block extra_head %}
<!-- Structured Data (JSON-LD) -->
<script type="application/ld+json">
{{ structured_data_json|safe }}
</script>
{% endblock %}

{% block content %}
<!-- Story Header -->
<div class="bg-white rounded-lg shadow-sm p-8 mb-8">
    <div class="flex justify-between items-start mb-4">
        <div>
            <span class="text-xs font-semibold px-2 py-1 bg-indigo-100 text-indigo-800 rounded">{{ story.get_genre_display }}</span>
        </div>
        <div>
            {% if user.is_authenticated %}
                <form action="{% url 'stories:subscribe_story' story.slug %}" method="post" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="{% if is_subscribed %}bg-gray-200 text-gray-700{% else %}bg-indigo-600 text-white{% endif %} px-4 py-2 rounded-lg font-semibold hover:opacity-90">
                        {% if is_subscribed %}Subscribed ✓{% else %}Subscribe{% endif %}
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ story.title }}</h1>
    <p class="text-lg text-gray-600 mb-6">{{ story.description }}</p>

    <div class="flex items-center gap-6 text-sm text-gray-500">
        <span>By {{ story.created_by.username }}</span>
        <span>{{ story.total_chapters }} chapter{{ story.total_chapters|pluralize }}</span>
        <span>{{ story.subscriber_count }} subscriber{{ story.subscriber_count|pluralize }}</span>
    </div>

    <!-- Social Sharing Buttons -->
    <div class="mt-6 pt-6 border-t border-gray-200">
        <p class="text-sm font-medium text-gray-700 mb-3">Share this story:</p>
        <div class="flex flex-wrap gap-3">
            <!-- Twitter -->
            <a href="https://twitter.com/intent/tweet?text={{ story.title|urlencode }}&url={{ request.build_absolute_uri }}&via=PlotVoteApp"
               target="_blank"
               rel="noopener noreferrer"
               class="inline-flex items-center gap-2 bg-blue-400 hover:bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg transition">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                </svg>
                Twitter
            </a>

            <!-- Facebook -->
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}"
               target="_blank"
               rel="noopener noreferrer"
               class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg transition">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
                Facebook
            </a>

            <!-- Reddit -->
            <a href="https://reddit.com/submit?url={{ request.build_absolute_uri }}&title={{ story.title|urlencode }}"
               target="_blank"
               rel="noopener noreferrer"
               class="inline-flex items-center gap-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold px-4 py-2 rounded-lg transition">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                </svg>
                Reddit
            </a>

            <!-- LinkedIn -->
            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}"
               target="_blank"
               rel="noopener noreferrer"
               class="inline-flex items-center gap-2 bg-blue-700 hover:bg-blue-800 text-white font-semibold px-4 py-2 rounded-lg transition">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
                LinkedIn
            </a>

            <!-- Copy Link -->
            <button onclick="copyStoryLink()"
                    id="copy-link-btn"
                    class="inline-flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                Copy Link
            </button>
        </div>
    </div>

    <script>
        function copyStoryLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(function() {
                const btn = document.getElementById('copy-link-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Copied!
                `;
                btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                btn.classList.add('bg-green-200', 'text-green-800');

                setTimeout(function() {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-200', 'text-green-800');
                    btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
                }, 2000);
            }, function(err) {
                alert('Failed to copy link. Please copy manually: ' + url);
            });
        }
    </script>
</div>

<!-- Story Status Section -->
{% if story.status == 'completed' %}
    <!-- Completed Story Badge (for any story type) -->
    <div class="bg-gradient-to-r from-gray-700 to-gray-900 rounded-lg shadow-lg p-8 mb-8 text-white">
        <div class="flex items-center justify-center mb-4">
            <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <h2 class="text-2xl font-bold mb-2 text-center">Story Complete!</h2>
        <p class="text-gray-300 text-center">
            This story has been completed with {{ story.total_chapters }} chapter{{ story.total_chapters|pluralize }}.
        </p>
    </div>
{% elif story.story_type == 'collaborative' %}
    <!-- Collaborative Story Section -->
    {% if user.is_authenticated and story.created_by == user and story.planned_chapters and story.total_chapters >= story.planned_chapters %}
        <!-- Author's story reached planned chapters - show Mark Complete option -->
        <div class="bg-gradient-to-r from-amber-500 to-orange-600 rounded-lg shadow-lg p-8 mb-8 text-white">
            <h2 class="text-2xl font-bold mb-2">Your Story Reached Planned Length!</h2>
            <p class="text-amber-100 mb-6">
                You've written {{ story.total_chapters }} of {{ story.planned_chapters }} planned chapters. Mark this story as complete to stop accepting new prompts, or let the community continue.
            </p>
            <div class="text-center space-x-4">
                <form method="post" action="{% url 'stories:mark_complete' story.slug %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="inline-block bg-white text-orange-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                        Mark as Complete
                    </button>
                </form>
                <span class="text-amber-100 text-sm">The community can still submit prompts if you don't mark it complete.</span>
            </div>
        </div>
    {% endif %}

    <!-- Collaborative Prompt Submission -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-8 mb-8 text-white">
        <h2 class="text-2xl font-bold mb-2">
            {% if current_prompts %}
                Vote for Chapter {{ story.current_chapter_number }}!
            {% else %}
                Submit Ideas for Chapter {{ story.current_chapter_number }}!
            {% endif %}
        </h2>
        <p class="text-indigo-100 mb-6">
            {% if current_prompts %}
                What should happen next? Vote for your favorite prompt below.
            {% else %}
                Be the first to suggest what happens next! Submit your prompt below.
            {% endif %}
        </p>

        {% if current_prompts %}
            <div class="space-y-4">
                {% for prompt in current_prompts %}
                    <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <p class="text-white font-medium">{{ prompt.prompt_text }}</p>
                                <p class="text-indigo-200 text-sm mt-1">by {{ prompt.user.username }}</p>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-2xl font-bold">{{ prompt.vote_count }}</div>
                                <div class="text-sm text-indigo-200">vote{{ prompt.vote_count|pluralize }}</div>
                            </div>
                        </div>

                        {% if user.is_authenticated %}
                            <form action="{% url 'stories:vote_prompt' prompt.id %}" method="post" class="mt-3">
                                {% csrf_token %}
                                <button type="submit" class="{% if user_voted_prompt.id == prompt.id %}bg-yellow-400 text-gray-900{% else %}bg-white/20 text-white{% endif %} px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/30 transition">
                                    {% if user_voted_prompt.id == prompt.id %}Your Vote ✓{% else %}Vote for This{% endif %}
                                </button>
                            </form>
                        {% else %}
                            <a href="{% url 'login' %}" class="inline-block bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/30 transition mt-3">
                                Login to Vote
                            </a>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="mt-6 text-center">
            {% if user.is_authenticated %}
                <a href="{% url 'stories:submit_prompt' story.slug %}" class="inline-block bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                    {% if current_prompts %}Submit Your Own Prompt{% else %}Submit First Prompt{% endif %}
                </a>
            {% else %}
                <a href="{% url 'login' %}" class="inline-block bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                    Login to Submit Prompt
                </a>
            {% endif %}
        </div>
    </div>
{% else %}
    <!-- Personal Story Section -->
    {% if user.is_authenticated and story.created_by == user %}
        {% if story.status == 'completed' %}
            <!-- Story Completed Badge -->
            <div class="bg-gradient-to-r from-gray-700 to-gray-900 rounded-lg shadow-lg p-8 mb-8 text-white">
                <div class="flex items-center justify-center mb-4">
                    <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-center">Story Complete!</h2>
                <p class="text-gray-300 text-center">
                    You've finished this story with {{ story.total_chapters }} chapter{{ story.total_chapters|pluralize }}.
                </p>
            </div>
        {% else %}
            <!-- Continue Writing or Mark Complete -->
            <div class="bg-gradient-to-r from-green-500 to-teal-600 rounded-lg shadow-lg p-8 mb-8 text-white">
                {% if story.planned_chapters and story.total_chapters >= story.planned_chapters %}
                    <!-- Story reached planned chapters - show Mark Complete option -->
                    <h2 class="text-2xl font-bold mb-2">Story Reached Planned Length!</h2>
                    <p class="text-green-100 mb-6">
                        You've written {{ story.total_chapters }} of {{ story.planned_chapters }} planned chapters. Mark this story as complete or continue writing.
                    </p>
                    <div class="text-center space-x-4">
                        <form method="post" action="{% url 'stories:mark_complete' story.slug %}" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="inline-block bg-white text-green-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                                Mark as Complete
                            </button>
                        </form>
                        <a href="{% url 'stories:continue_personal_story' story.slug %}" class="inline-block bg-green-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-800 transition">
                            Continue Writing
                        </a>
                    </div>
                {% else %}
                    <!-- Normal continue writing -->
                    <h2 class="text-2xl font-bold mb-2">Continue Your Story</h2>
                    <p class="text-green-100 mb-6">
                        Write what happens next in Chapter {{ story.current_chapter_number }}. {% if story.planned_chapters %}({{ story.total_chapters }} of {{ story.planned_chapters }} chapters written){% endif %}
                    </p>
                    <div class="text-center space-x-4">
                        <a href="{% url 'stories:continue_personal_story' story.slug %}" class="inline-block bg-white text-green-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                            {% if chapters %}Continue Writing{% else %}Start Writing Chapter 1{% endif %}
                        </a>
                        {% if chapters %}
                            <!-- Only show publish option if at least 1 chapter exists -->
                            <form method="post" action="{% url 'stories:publish_to_community' story.slug %}" class="inline" onsubmit="return confirm('Are you sure you want to publish this story to the community? Other users will be able to submit and vote on prompts for future chapters. This cannot be undone.');">
                                {% csrf_token %}
                                <button type="submit" class="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                                    Publish to Community
                                </button>
                            </form>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endif %}
    {% endif %}
{% endif %}

<!-- Chapters List -->
<div class="bg-white rounded-lg shadow-sm p-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Chapters</h2>

    {% if chapters %}
        <div class="space-y-4">
            {% for chapter in chapters %}
                <a href="{% url 'stories:chapter_detail' story.slug chapter.chapter_number %}" class="block border rounded-lg p-4 hover:bg-gray-50 transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-lg text-gray-900">
                                Chapter {{ chapter.chapter_number }}: {{ chapter.title }}
                            </h3>
                            <p class="text-sm text-gray-500 mt-1">
                                {{ chapter.word_count }} words • {{ chapter.read_time_minutes }} min read • {{ chapter.published_at|date:"M d, Y" }}
                            </p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </a>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 text-center py-8">No chapters published yet. Be the first to submit a prompt!</p>
    {% endif %}
</div>
{% endblock %}
