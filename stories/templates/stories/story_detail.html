{% extends 'base.html' %}

{% block title %}{{ story.title }} - PlotVote{% endblock %}

{% block content %}
<!-- Story Header -->
<div class="bg-white rounded-lg shadow-sm p-8 mb-8">
    <div class="flex justify-between items-start mb-4">
        <div>
            <span class="text-xs font-semibold px-2 py-1 bg-indigo-100 text-indigo-800 rounded">{{ story.get_genre_display }}</span>
        </div>
        <div>
            {% if user.is_authenticated %}
                <form action="{% url 'stories:subscribe_story' story.slug %}" method="post" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="{% if is_subscribed %}bg-gray-200 text-gray-700{% else %}bg-indigo-600 text-white{% endif %} px-4 py-2 rounded-lg font-semibold hover:opacity-90">
                        {% if is_subscribed %}Subscribed ✓{% else %}Subscribe{% endif %}
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ story.title }}</h1>
    <p class="text-lg text-gray-600 mb-6">{{ story.description }}</p>

    <div class="flex items-center gap-6 text-sm text-gray-500">
        <span>By {{ story.created_by.username }}</span>
        <span>{{ story.total_chapters }} chapter{{ story.total_chapters|pluralize }}</span>
        <span>{{ story.subscriber_count }} subscriber{{ story.subscriber_count|pluralize }}</span>
    </div>
</div>

<!-- Current Voting / Prompt Submission -->
<div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-8 mb-8 text-white">
    <h2 class="text-2xl font-bold mb-2">
        {% if current_prompts %}
            Vote for Chapter {{ story.current_chapter_number }}!
        {% else %}
            Submit Ideas for Chapter {{ story.current_chapter_number }}!
        {% endif %}
    </h2>
    <p class="text-indigo-100 mb-6">
        {% if current_prompts %}
            What should happen next? Vote for your favorite prompt below.
        {% else %}
            Be the first to suggest what happens next! Submit your prompt below.
        {% endif %}
    </p>

    {% if current_prompts %}
        <div class="space-y-4">
            {% for prompt in current_prompts %}
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="text-white font-medium">{{ prompt.prompt_text }}</p>
                            <p class="text-indigo-200 text-sm mt-1">by {{ prompt.user.username }}</p>
                        </div>
                        <div class="text-right ml-4">
                            <div class="text-2xl font-bold">{{ prompt.vote_count }}</div>
                            <div class="text-sm text-indigo-200">vote{{ prompt.vote_count|pluralize }}</div>
                        </div>
                    </div>

                    {% if user.is_authenticated %}
                        <form action="{% url 'stories:vote_prompt' prompt.id %}" method="post" class="mt-3">
                            {% csrf_token %}
                            <button type="submit" class="{% if user_voted_prompt.id == prompt.id %}bg-yellow-400 text-gray-900{% else %}bg-white/20 text-white{% endif %} px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/30 transition">
                                {% if user_voted_prompt.id == prompt.id %}Your Vote ✓{% else %}Vote for This{% endif %}
                            </button>
                        </form>
                    {% else %}
                        <a href="{% url 'login' %}" class="inline-block bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/30 transition mt-3">
                            Login to Vote
                        </a>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="mt-6 text-center">
        {% if user.is_authenticated %}
            <a href="{% url 'stories:submit_prompt' story.slug %}" class="inline-block bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                {% if current_prompts %}Submit Your Own Prompt{% else %}Submit First Prompt{% endif %}
            </a>
        {% else %}
            <a href="{% url 'login' %}" class="inline-block bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                Login to Submit Prompt
            </a>
        {% endif %}
    </div>
</div>

<!-- Chapters List -->
<div class="bg-white rounded-lg shadow-sm p-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Chapters</h2>

    {% if chapters %}
        <div class="space-y-4">
            {% for chapter in chapters %}
                <a href="{% url 'stories:chapter_detail' story.slug chapter.chapter_number %}" class="block border rounded-lg p-4 hover:bg-gray-50 transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-lg text-gray-900">
                                Chapter {{ chapter.chapter_number }}: {{ chapter.title }}
                            </h3>
                            <p class="text-sm text-gray-500 mt-1">
                                {{ chapter.word_count }} words • {{ chapter.read_time_minutes }} min read • {{ chapter.published_at|date:"M d, Y" }}
                            </p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </a>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 text-center py-8">No chapters published yet. Be the first to submit a prompt!</p>
    {% endif %}
</div>
{% endblock %}
